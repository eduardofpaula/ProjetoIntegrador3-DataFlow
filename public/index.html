<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../src/utils/vue.js"></script>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <link rel="stylesheet" href="../src/assets/style/index-home.css" />
  <title>Home</title>
</head>

<body>
  <div id="app">
    <header>
      <img src="../src/assets/images/logo-dom-rock.png" alt="logo-dom-rock" id="logo" />
      <nav>
        <a href="/public/index.html">Home</a>
        <a href="../src/pages/upload-csv.html">Importar novo Arquivo</a>
        <a href="#"><img src="../src/assets/images/foto-perfil-branco.png" alt="foto-perfil-branco"
            id="fotoPerfilIcon" /></a>
      </nav>
    </header>

    <main>
      <h1>Olá, Bem Vindo</h1>

      <table id="table">
        <thead>
          <tr>
            <th @click="sortByFileName">Nome do Arquivo</th>
            <th>Organização</th>
            <th>Status</th>
            <th>Excluir</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(file, index) in files" :key="index">
            <td>
              <div id="centralizar">
                <img src="../src/assets/images/arquivo.png" alt="arquivo" id="img-table">
                <a href="#" @click="viewFileDetails(file)">{{ file.nomeArquivo }}</a>
              </div>
            </td>
            <td>
              <div id="centralizar">
                <img src="../src/assets/images/organizacao.png" alt="organizacao" id="img-table">
                {{ file.organizacao }}
              </div>
            </td>
            <td class="status-cell">
              <div id="centralizar">
                <img src="../src/assets/images/status-amarelo.png" alt="status-amarelo" id="img-table">
                {{ file.status }}
              </div>
            </td>
            <td>
              <div id="centralizar">
                <a href="#" @click="checkExclud(file)">
                  <span class="material-symbols-outlined" style="color: rgb(221, 24, 24);">
                    delete
                  </span>
                </a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </main>
  </div>

  <script>
    const app = new Vue({
      el: "#app",
      data: {
        files: [],
      },
      mounted() {
        // Carregar os dados do usuário ao abrir a página, usuário fixo por enquanto
        sessionStorage.setItem("usuario", "usuario1@email.com")

        this.loadUserData(sessionStorage.getItem("usuario"));
      },
      methods: {
        loadUserData(email) {
          fetch("http://localhost:8080/home/files/find", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email: email }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data && data.response) {
                // Concatenar as listas de arquivos de todas as categorias
                const allFiles = [
                  ...data.response.arquivosLanding,
                  ...data.response.arquivosBronze,
                  ...data.response.arquivosSilver,
                ];

                // Mapear os arquivos para o formato desejado
                this.files = allFiles.map((arquivo) => {
                  return {
                    nomeArquivo: arquivo.nome,
                    organizacao: arquivo.organizacao,
                    status: arquivo.status,
                  };
                });
              }
            })
            .catch((error) => {
              console.error("Erro ao carregar os dados do usuário:", error);
            });
        },
        sortByFileName() {
          // Implementar a lógica para ordenar os arquivos pelo nome do arquivo, se necessário
        },
        viewFileDetails(file) {
          localStorage.setItem("fileName", file.nomeArquivo);
          localStorage.setItem("usuario", "usuario1@email.com");

          if (file.status === "AGUARDANDO APROVAÇÃO DA BRONZE") {
            window.location.href = "../src/pages/validate.html";
          } else if (file.status === "BRONZE ZONE") {
            window.location.href = "../src/pages/bronze-zone-hash.html";
          } else if (file.status === "NÃO APROVADO PELA BRONZE") {
            window.location.href = "../src/pages/update_csv.html";}
          else {
            console.error("Status desconhecido:", file.status);
          }
        },
        checkExclud(file) {
          Swal.fire({
            title: 'Tem certeza?',
            text: 'Esta ação não pode ser desfeita!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              this.excludeFile(file)
            }
          });
        },
        excludeFile(file) {

          console.log(file)

          // Construindo o objeto completo
          const objetoCompleto = {
            nomeArquivo: file.nomeArquivo,
            usuario: sessionStorage.getItem("usuario"),
            usuarioOrg: file.organizacao,
          };

          //Enviar dados para o backend
          fetch("http://localhost:8080/home/files", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(objetoCompleto),
          }).then((response) => {
            return response.json();
          }).then((responseJson) => {
            if (
              responseJson.critica !== "Processamento efetuado com sucesso"
            ) {
              Swal.fire({
                title: "Erro",
                text: responseJson.critica,
                icon: "error", // Ícone personalizado (success, error, warning, info)
                confirmButtonText: "OK", // Texto do botão de confirmação
              });
              return;
            } else {
              Swal.fire({
                title: "Sucesso",
                text: responseJson.critica,
                icon: "success", // Ícone personalizado (success, error, warning, info)
                confirmButtonText: "OK", // Texto do botão de confirmação
              }).then((result) => {
                window.location.href = "/public/index.html";
              });
            }
            // Lidar com a resposta do backend aqui se necessário
          })

        },
      },
    });
  </script>
  <script src="../src/utils/hover-icon-change-home.js"></script>
</body>

</html>